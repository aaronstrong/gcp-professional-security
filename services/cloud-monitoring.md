# Cloud Monitoring

**Table of contents:**
- [Stackdriver Overview](#stackdriver-overview)
- [Cloud Logging](#cloud-logging)
- [VPC Flow Logs](#vpc-flow-logs)
- [Cloud Monitoring and Alerting](#monitoring-alerting)
- [Stack Driver APM and Error Reporting](#apm-error-report)
- [Exporting Stackdriver Logs](#export-logs)

<a id="stackdriver-overview"></a>
## stackdriver-overview

Stackdriver is a suite of tools for logging, monitoring, and application diagnostics. Ingests this data dn generate insights via dashboards, charts, and alerts

Available for GCP and AWS.
    - Connect using an AWS role and GCP service account
    - VM Monitoring with agents

Benefits:
- Single pane of glass with dashboards
- Centralized logging platform for GCP and AWS
- Integrate with third parties like Splunk, BMS, SumoLogic

<a id="cloud-logging"></a>
## Cloud Logging

Overview:
- Central repo for log data from multiple resources
- real-time log management and analysis
- Tight integration with monitoring
- Export logs to other sources
    - long-term storage
    - analysis
- Associated primarily with GCP projects.
    - **Log Viewer** only shows logs from 1 project.
- Retention Period
    - Length of time for which your logs are kept


<b><u>Types of Logs</b></u>
- Audit Logs
    - Who did what, where and when?
    - Admin activity
    - Data Access logs
    - System events
- Access Transparency Logs
    - Actions taken by Google staff when accessing your data
- Agent logs
    - Logging agent that runs on VMs
    - Sends system and third-party logs on the VM instance to Cloud Logging

<b><u>Audit Log Types</b></u>
- Admin Activity Logs
    - API call or other administrative actions
    - Always written
    - CAnnot be disabled
    - Not charged for these logs
- Data Access Logs
    - API calls that create, modify, or read resources data provided by the user
    - Disabled by default, can be large and cost $$$
    - Must be explicitly enabled to be written
- System Event Logs
    - GCP Administrative actions
    - Generated by Google, not by user action
    - Always written
    - CAnnot be disabled
    - Not charged for these logs

<b><u>Agent Logs</b></u>
- Logging agent that runs on VMs
- Sends system and third-party logs on the VM instance to Stackdriver logging
- Free tier limit

<b><u>Log Retention</b></u>

| Log Type | Retention Period|
|  --- | --- |
| Admin activity audit logs | 400 days |
| Data Access audit logs | 30 days |
| System Event audit logs | 400 days |
| Logs other than audit log or Access Transparency logs | 30 days|

>**Note**: First 50 GiB per project free

<a id="vpc-flow-logs"></a>
## VPC Flow Logs

VPC flow logs record a sample of network flows sent from and received by VM instances. These logs can be used for network monitoring, forensics, real-time security analysis, and expense optimization.


<b><u>Overview</b></u>

- Flow logs can be viewed in Cloud Logging
- Aggregated by connection from VMs and exported in real time
- Subscribing to Cloud Pub/Sub enables streaming so that flow logs can be analyzed in real time.
- Enabled/disabled per subnet.
- Each flow log covers all TCP and UDP flows
- Filters can be applied

<a id="monitoring-alerting"></a>
## Monitoring and Alerting

<b><u>Workspaces</b></u>
- Workspaces organize monitoring information in Cloud monitoring
- Single pane of glass
- To use cloud monitoring, you must have a workspace
- Best practice is to use multi-project workspace.

<b><u>Monitoring agent</b></u>
- Gathers system and application metrics from your VM and sends them to Cloud monitoring
- Without the agent, only CPU, Disk Traffic, Network traffic and uptime metrcis are collected.
- Using the agent is optional but recommended.
- Monitors many third-party applications
- Can also be used with GKE

<b><u>Policies</b></u>
- An alerting policy defines the conditions under which a service is considered unhealthy
- When these condiations are met, the policy is triggered and opens a new incident and or sends a notficaition.
- A policy belongs to an individual workspace
- Can have up to 500 policies

<b><u>Conditions</b></u>
- Determine when an alerting policy is triggered
- All conditions watch for three things
    1. Some metric
    1. behaving in some way
    1. for some period of time

<b><u>Notification Channel</b></u>
- How would you like to be notified
    - email, pagerduty, slack, sms



<a id="export-logs"></a>
## Export Logs

![](https://cdn-images-1.medium.com/max/800/1*xTAetTwgLUY8jwV-ESgO3A.png)